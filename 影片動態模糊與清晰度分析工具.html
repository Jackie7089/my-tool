<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>影片動態模糊與清晰度分析工具 (獨立微調版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chart.js and Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5;
        }
        .video-container {
            position: relative;
            width: 100%;
            background-color: #111827;
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        video {
            width: 100%;
            height: auto;
            max-height: 60vh;
            display: block;
        }
        .control-button {
            transition: all 0.2s ease-in-out;
        }
        .control-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .control-button:active {
            transform: scale(0.98);
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #d1d5db;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        .file-input-label {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .sharpness-display {
            font-family: 'Fira Code', 'monospace';
            background-color: rgba(0,0,0,0.6);
            color: #16a34a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .progress-bar {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background-color: #3b82f6;
            border-radius: 9999px;
            transition: width 0.1s linear;
        }
        .input-time {
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
        }
        .chart-legend-checkbox {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-screen-2xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">影片動態模糊與清晰度分析工具</h1>
            <p class="mt-2 text-lg text-gray-600">上傳三支影片，獨立微調影格以設定同步點，精準比較清晰度並查看合併趨勢圖。</p>
        </header>

        <!-- Video Selection -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div>
                <label for="video-input-a" class="file-input-label w-full text-center bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 hover:bg-gray-50 hover:border-blue-400">
                    <i class="fas fa-video fa-2x text-gray-400 mb-2"></i>
                    <span class="block font-semibold text-blue-600">點擊選擇影片 A</span>
                    <span id="filename-a" class="block text-sm text-gray-500 mt-1">尚未選擇檔案</span>
                </label>
                <input type="file" id="video-input-a" accept="video/*" class="hidden">
            </div>
            <div>
                <label for="video-input-b" class="file-input-label w-full text-center bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 hover:bg-gray-50 hover:border-orange-400">
                    <i class="fas fa-video fa-2x text-gray-400 mb-2"></i>
                    <span class="block font-semibold text-orange-600">點擊選擇影片 B</span>
                    <span id="filename-b" class="block text-sm text-gray-500 mt-1">尚未選擇檔案</span>
                </label>
                <input type="file" id="video-input-b" accept="video/*" class="hidden">
            </div>
            <div>
                <label for="video-input-c" class="file-input-label w-full text-center bg-white border-2 border-dashed border-gray-300 rounded-lg p-6 hover:bg-gray-50 hover:border-green-400">
                    <i class="fas fa-video fa-2x text-gray-400 mb-2"></i>
                    <span class="block font-semibold text-green-600">點擊選擇影片 C</span>
                    <span id="filename-c" class="block text-sm text-gray-500 mt-1">尚未選擇檔案</span>
                </label>
                <input type="file" id="video-input-c" accept="video/*" class="hidden">
            </div>
        </div>

        <!-- Hidden Canvases for analysis -->
        <canvas id="canvas-a" class="hidden"></canvas>
        <canvas id="canvas-b" class="hidden"></canvas>
        <canvas id="canvas-c" class="hidden"></canvas>

        <!-- Video Players -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-2 bg-gray-900 p-4 rounded-xl shadow-lg">
            <div class="space-y-2">
                <div class="video-container">
                    <video id="video-a"></video>
                </div>
                <div class="flex justify-between items-center text-white text-xs sm:text-sm p-1">
                    <span>清晰度: <span id="sharpness-a" class="sharpness-display">N/A</span></span>
                    <div class="flex items-center gap-2">
                        <button id="prev-frame-a" title="前一幀 (A)" class="p-1.5 bg-gray-700 rounded hover:bg-gray-600"><i class="fas fa-chevron-left"></i></button>
                        <button id="next-frame-a" title="後一幀 (A)" class="p-1.5 bg-gray-700 rounded hover:bg-gray-600"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <button id="set-sync-a" class="p-1.5 bg-blue-600 rounded hover:bg-blue-500"><i class="fas fa-anchor"></i> 設為同步點</button>
                    <span id="sync-point-a" class="w-24 text-right">同步點: 0.00s</span>
                </div>
            </div>
            <div class="space-y-2">
                <div class="video-container">
                    <video id="video-b"></video>
                </div>
                <div class="flex justify-between items-center text-white text-xs sm:text-sm p-1">
                    <span>清晰度: <span id="sharpness-b" class="sharpness-display">N/A</span></span>
                    <div class="flex items-center gap-2">
                        <button id="prev-frame-b" title="前一幀 (B)" class="p-1.5 bg-gray-700 rounded hover:bg-gray-600"><i class="fas fa-chevron-left"></i></button>
                        <button id="next-frame-b" title="後一幀 (B)" class="p-1.5 bg-gray-700 rounded hover:bg-gray-600"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <button id="set-sync-b" class="p-1.5 bg-orange-600 rounded hover:bg-orange-500"><i class="fas fa-anchor"></i> 設為同步點</button>
                    <span id="sync-point-b" class="w-24 text-right">同步點: 0.00s</span>
                </div>
            </div>
            <div class="space-y-2">
                <div class="video-container">
                    <video id="video-c"></video>
                </div>
                <div class="flex justify-between items-center text-white text-xs sm:text-sm p-1">
                    <span>清晰度: <span id="sharpness-c" class="sharpness-display">N/A</span></span>
                     <div class="flex items-center gap-2">
                        <button id="prev-frame-c" title="前一幀 (C)" class="p-1.5 bg-gray-700 rounded hover:bg-gray-600"><i class="fas fa-chevron-left"></i></button>
                        <button id="next-frame-c" title="後一幀 (C)" class="p-1.5 bg-gray-700 rounded hover:bg-gray-600"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <button id="set-sync-c" class="p-1.5 bg-green-600 rounded hover:bg-green-500"><i class="fas fa-anchor"></i> 設為同步點</button>
                    <span id="sync-point-c" class="w-24 text-right">同步點: 0.00s</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div id="controls-panel" class="bg-white p-4 rounded-xl shadow-lg space-y-4 hidden">
            <div class="flex items-center justify-center space-x-4">
                <button id="prev-frame" title="同步前進一幀" class="control-button w-14 h-14 md:w-16 md:h-16 text-lg md:text-xl bg-gray-200 text-gray-700 rounded-full flex items-center justify-center shadow-md"><i class="fas fa-backward-step"></i></button>
                <button id="play-pause" class="control-button w-16 h-16 md:w-20 md:h-20 text-2xl md:text-3xl bg-blue-500 text-white rounded-full flex items-center justify-center shadow-lg"><i id="play-icon" class="fas fa-play"></i></button>
                <button id="next-frame" title="同步後退一幀" class="control-button w-14 h-14 md:w-16 md:h-16 text-lg md:text-xl bg-gray-200 text-gray-700 rounded-full flex items-center justify-center shadow-md"><i class="fas fa-forward-step"></i></button>
            </div>
            <div class="flex items-center gap-4">
                <span id="current-time" class="text-sm font-mono text-gray-600">00:00</span>
                <input type="range" id="seek-bar" value="0" step="0.01" class="flex-grow">
                <span id="duration" class="text-sm font-mono text-gray-600">00:00</span>
            </div>
        </div>
        
        <!-- Analysis Panel -->
        <div id="analysis-panel" class="mt-8 bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">清晰度量化分析</h2>
            <div class="space-y-6">
                <!-- Time Range Selection -->
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">1. 設定分析範圍 (相對於同步點)</h3>
                     <p class="text-xs text-gray-500 mb-2">請先設定同步點，此處的開始/結束時間是相對於同步點的秒數。留白則分析整段影片。</p>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label for="start-time">開始:</label>
                            <input type="number" id="start-time" class="input-time w-24" placeholder="0.0" min="0">
                            <button id="set-start-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-lg">設為開始點</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="end-time">結束:</label>
                            <input type="number" id="end-time" class="input-time w-24" placeholder="結尾" min="0">
                             <button id="set-end-btn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-lg">設為結束點</button>
                        </div>
                         <button id="reset-sync-btn" class="text-sm bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg"><i class="fas fa-undo"></i> 重置同步點</button>
                    </div>
                </div>

                <!-- Sharpness Thresholds -->
                <div>
                    <h3 class="font-medium text-gray-700 mb-2">2. 設定清晰度三級閥值</h3>
                    <div class="space-y-3">
                        <div class="flex items-center gap-4">
                            <label for="clear-threshold-slider" class="w-20 text-sm text-green-600 font-semibold">清楚閥值:</label>
                            <input type="range" id="clear-threshold-slider" min="0" max="5000" value="500" class="flex-grow">
                            <input type="number" id="clear-threshold-input" class="input-time w-24" value="500" min="0" max="5000">
                        </div>
                        <div class="flex items-center gap-4">
                             <label for="blurry-threshold-slider" class="w-20 text-sm text-red-600 font-semibold">模糊閥值:</label>
                            <input type="range" id="blurry-threshold-slider" min="0" max="5000" value="100" class="flex-grow">
                            <input type="number" id="blurry-threshold-input" class="input-time w-24" value="100" min="0" max="5000">
                        </div>
                    </div>
                </div>
                
                <button id="analyze-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 text-lg">
                    <i class="fas fa-chart-line"></i>
                    開始分析
                </button>
                <div id="analysis-progress-container" class="hidden space-y-2">
                    <div class="progress-bar h-4">
                        <div id="progress-bar-inner" class="progress-bar-inner h-4"></div>
                    </div>
                    <p id="progress-text" class="text-center text-sm text-gray-600">分析中...</p>
                </div>
            </div>
            <!-- Results & Charts Container -->
            <div id="results-charts-container" class="mt-6 space-y-8 hidden">
                <!-- Statistics -->
                <div id="results-container" class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div id="result-a" class="bg-gray-50 p-4 rounded-lg hidden">
                        <h3 class="font-bold text-lg text-gray-700">影片 A 結果</h3>
                        <div class="mt-2 space-y-1 text-sm">
                            <p>平均清晰度: <span id="avg-sharpness-a" class="font-bold text-lg text-blue-600">-</span></p>
                            <p class="text-green-600">清楚比例: <span id="clear-ratio-a" class="font-bold text-lg">-%</span></p>
                            <p class="text-yellow-600">小糊比例: <span id="slight-ratio-a" class="font-bold text-lg">-%</span></p>
                            <p class="text-red-600">大糊比例: <span id="blur-ratio-a" class="font-bold text-lg">-%</span></p>
                        </div>
                    </div>
                    <div id="result-b" class="bg-gray-50 p-4 rounded-lg hidden">
                        <h3 class="font-bold text-lg text-gray-700">影片 B 結果</h3>
                        <div class="mt-2 space-y-1 text-sm">
                            <p>平均清晰度: <span id="avg-sharpness-b" class="font-bold text-lg text-orange-600">-</span></p>
                            <p class="text-green-600">清楚比例: <span id="clear-ratio-b" class="font-bold text-lg">-%</span></p>
                            <p class="text-yellow-600">小糊比例: <span id="slight-ratio-b" class="font-bold text-lg">-%</span></p>
                            <p class="text-red-600">大糊比例: <span id="blur-ratio-b" class="font-bold text-lg">-%</span></p>
                        </div>
                    </div>
                     <div id="result-c" class="bg-gray-50 p-4 rounded-lg hidden">
                        <h3 class="font-bold text-lg text-gray-700">影片 C 結果</h3>
                        <div class="mt-2 space-y-1 text-sm">
                            <p>平均清晰度: <span id="avg-sharpness-c" class="font-bold text-lg text-green-600">-</span></p>
                            <p class="text-green-600">清楚比例: <span id="clear-ratio-c" class="font-bold text-lg">-%</span></p>
                            <p class="text-yellow-600">小糊比例: <span id="slight-ratio-c" class="font-bold text-lg">-%</span></p>
                            <p class="text-red-600">大糊比例: <span id="blur-ratio-c" class="font-bold text-lg">-%</span></p>
                        </div>
                    </div>
                </div>
                 <!-- Combined Chart -->
                <div id="combined-chart-container" class="hidden pt-6">
                    <h3 class="font-bold text-lg text-gray-700 text-center mb-2">清晰度趨勢比較圖</h3>
                    <canvas id="combined-chart"></canvas>
                    <!-- Chart Legend Controls -->
                    <div id="chart-legend-controls" class="mt-4 flex justify-center items-center gap-6 text-sm hidden">
                         <label for="show-line-a" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="show-line-a" class="chart-legend-checkbox text-blue-600 focus:ring-blue-500" checked>
                            <span class="w-4 h-1 mr-2 bg-blue-500"></span>
                            顯示影片 A
                        </label>
                         <label for="show-line-b" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="show-line-b" class="chart-legend-checkbox text-orange-600 focus:ring-orange-500" checked>
                            <span class="w-4 h-1 mr-2 bg-orange-500"></span>
                            顯示影片 B
                        </label>
                         <label for="show-line-c" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="show-line-c" class="chart-legend-checkbox text-green-600 focus:ring-green-500" checked>
                            <span class="w-4 h-1 mr-2 bg-green-500"></span>
                            顯示影片 C
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const videoInputA = document.getElementById('video-input-a'), videoInputB = document.getElementById('video-input-b'), videoInputC = document.getElementById('video-input-c');
        const filenameA = document.getElementById('filename-a'), filenameB = document.getElementById('filename-b'), filenameC = document.getElementById('filename-c');
        const videoA = document.getElementById('video-a'), videoB = document.getElementById('video-b'), videoC = document.getElementById('video-c');
        const canvasA = document.getElementById('canvas-a'), canvasB = document.getElementById('canvas-b'), canvasC = document.getElementById('canvas-c');
        const controlsPanel = document.getElementById('controls-panel'), analysisPanel = document.getElementById('analysis-panel');
        const playPauseBtn = document.getElementById('play-pause'), playIcon = document.getElementById('play-icon');
        const prevFrameBtn = document.getElementById('prev-frame'), nextFrameBtn = document.getElementById('next-frame');
        const seekBar = document.getElementById('seek-bar');
        const currentTimeEl = document.getElementById('current-time'), durationEl = document.getElementById('duration');
        const sharpnessADisplay = document.getElementById('sharpness-a'), sharpnessBDisplay = document.getElementById('sharpness-b'), sharpnessCDisplay = document.getElementById('sharpness-c');
        
        // Individual Frame Controls
        const prevFrameA = document.getElementById('prev-frame-a'), nextFrameA = document.getElementById('next-frame-a');
        const prevFrameB = document.getElementById('prev-frame-b'), nextFrameB = document.getElementById('next-frame-b');
        const prevFrameC = document.getElementById('prev-frame-c'), nextFrameC = document.getElementById('next-frame-c');
        
        const setSyncA = document.getElementById('set-sync-a'), setSyncB = document.getElementById('set-sync-b'), setSyncC = document.getElementById('set-sync-c');
        const syncPointA = document.getElementById('sync-point-a'), syncPointB = document.getElementById('sync-point-b'), syncPointC = document.getElementById('sync-point-c');
        
        // --- Analysis Elements ---
        const analyzeBtn = document.getElementById('analyze-button');
        const resetSyncBtn = document.getElementById('reset-sync-btn');
        const clearThresholdSlider = document.getElementById('clear-threshold-slider');
        const clearThresholdInput = document.getElementById('clear-threshold-input');
        const blurryThresholdSlider = document.getElementById('blurry-threshold-slider');
        const blurryThresholdInput = document.getElementById('blurry-threshold-input');
        const startTimeInput = document.getElementById('start-time'), endTimeInput = document.getElementById('end-time');
        const setStartBtn = document.getElementById('set-start-btn'), setEndBtn = document.getElementById('set-end-btn');
        const progressContainer = document.getElementById('analysis-progress-container');
        const progressBar = document.getElementById('progress-bar-inner');
        const progressText = document.getElementById('progress-text');
        
        // --- Results & Charts Elements ---
        const resultsChartsContainer = document.getElementById('results-charts-container');
        const resultAEl = document.getElementById('result-a'), resultBEl = document.getElementById('result-b'), resultCEl = document.getElementById('result-c');
        const avgSharpnessA = document.getElementById('avg-sharpness-a'), avgSharpnessB = document.getElementById('avg-sharpness-b'), avgSharpnessC = document.getElementById('avg-sharpness-c');
        const clearRatioA = document.getElementById('clear-ratio-a'), clearRatioB = document.getElementById('clear-ratio-b'), clearRatioC = document.getElementById('clear-ratio-c');
        const slightRatioA = document.getElementById('slight-ratio-a'), slightRatioB = document.getElementById('slight-ratio-b'), slightRatioC = document.getElementById('slight-ratio-c');
        const blurRatioA = document.getElementById('blur-ratio-a'), blurRatioB = document.getElementById('blur-ratio-b'), blurRatioC = document.getElementById('blur-ratio-c');
        const combinedChartContainer = document.getElementById('combined-chart-container');
        const chartLegendControls = document.getElementById('chart-legend-controls');
        const showLineA = document.getElementById('show-line-a'), showLineB = document.getElementById('show-line-b'), showLineC = document.getElementById('show-line-c');
        let combinedChartInstance;


        // --- State ---
        let isPlaying = false;
        let videosLoaded = { a: false, b: false, c: false };
        let isAnalyzing = false;
        let analysisCancelled = false;
        const FRAME_STEP = 1 / 60;
        let syncPoints = { a: 0, b: 0, c: 0 };
        let lastAnalysisData = null; // To store the last analysis results

        // --- Event Listeners ---
        videoInputA.addEventListener('change', (e) => loadVideo(e, videoA, 'a', filenameA, canvasA));
        videoInputB.addEventListener('change', (e) => loadVideo(e, videoB, 'b', filenameB, canvasB));
        videoInputC.addEventListener('change', (e) => loadVideo(e, videoC, 'c', filenameC, canvasC));

        // Global Controls
        playPauseBtn.addEventListener('click', togglePlayPause);
        seekBar.addEventListener('input', () => { if (!isPlaying) { seekVideos(seekBar.value, true); } });
        seekBar.addEventListener('change', () => seekVideos(seekBar.value, true));
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            const anyLoaded = videosLoaded.a || videosLoaded.b || videosLoaded.c;
            if (e.code === 'Space' && anyLoaded) { e.preventDefault(); togglePlayPause(); }
            if (e.code === 'ArrowLeft' && anyLoaded) stepFrame(-1);
            if (e.code === 'ArrowRight' && anyLoaded) stepFrame(1);
        });
        prevFrameBtn.addEventListener('click', () => stepFrame(-1));
        nextFrameBtn.addEventListener('click', () => stepFrame(1));
        videoA.addEventListener('timeupdate', updateUI);
        [videoA, videoB, videoC].forEach(v => v.addEventListener('loadedmetadata', checkAllVideosLoaded));
        
        // --- Individual Frame Control Listeners ---
        prevFrameA.addEventListener('click', () => stepIndividualFrame('a', -1));
        nextFrameA.addEventListener('click', () => stepIndividualFrame('a', 1));
        prevFrameB.addEventListener('click', () => stepIndividualFrame('b', -1));
        nextFrameB.addEventListener('click', () => stepIndividualFrame('b', 1));
        prevFrameC.addEventListener('click', () => stepIndividualFrame('c', -1));
        nextFrameC.addEventListener('click', () => stepIndividualFrame('c', 1));
        
        // --- Sync Point Listeners ---
        setSyncA.addEventListener('click', () => setSyncPoint('a'));
        setSyncB.addEventListener('click', () => setSyncPoint('b'));
        setSyncC.addEventListener('click', () => setSyncPoint('c'));
        resetSyncBtn.addEventListener('click', resetSyncPoints);


        // --- Analysis Listeners ---
        analyzeBtn.addEventListener('click', () => {
            if (isAnalyzing) {
                stopAnalysis();
            } else {
                startFullAnalysis();
            }
        });
        
        // --- Chart Legend Listeners ---
        [showLineA, showLineB, showLineC].forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if(lastAnalysisData) {
                    redrawChart();
                }
            });
        });

        // Thresholds Sync Logic
        function syncThresholds(source) {
            let clearVal = parseInt(clearThresholdInput.value);
            let blurryVal = parseInt(blurryThresholdInput.value);
            if (isNaN(clearVal) || isNaN(blurryVal)) return;

            if (source === 'clear' && clearVal < blurryVal) {
                blurryThresholdSlider.value = clearVal;
                blurryThresholdInput.value = clearVal;
            }
            if (source === 'blurry' && blurryVal > clearVal) {
                clearThresholdSlider.value = blurryVal;
                clearThresholdInput.value = blurryVal;
            }
        }
        [clearThresholdSlider, clearThresholdInput].forEach(el => el.addEventListener('input', () => {
            if (el.type === 'range') clearThresholdInput.value = el.value;
            if (el.type === 'number') clearThresholdSlider.value = el.value;
            syncThresholds('clear');
        }));
        [blurryThresholdSlider, blurryThresholdInput].forEach(el => el.addEventListener('input', () => {
            if (el.type === 'range') blurryThresholdInput.value = el.value;
            if (el.type === 'number') blurryThresholdSlider.value = el.value;
            syncThresholds('blurry');
        }));

        const getMainVideo = () => videosLoaded.a ? videoA : (videosLoaded.b ? videoB : (videosLoaded.c ? videoC : null));

        setStartBtn.addEventListener('click', () => { 
            const mainVideo = getMainVideo();
            if (mainVideo) startTimeInput.value = (mainVideo.currentTime - syncPoints[getVideoKey(mainVideo)]).toFixed(2);
        });
        setEndBtn.addEventListener('click', () => {
            const mainVideo = getMainVideo();
            if(mainVideo) endTimeInput.value = (mainVideo.currentTime - syncPoints[getVideoKey(mainVideo)]).toFixed(2);
        });


        // --- Core Functions ---
        function getVideoKey(videoElement) {
            if (videoElement === videoA) return 'a';
            if (videoElement === videoB) return 'b';
            if (videoElement === videoC) return 'c';
            return null;
        }

        function setSyncPoint(key) {
            const video = document.getElementById(`video-${key}`);
            if (video && !isNaN(video.currentTime)) {
                syncPoints[key] = video.currentTime;
                document.getElementById(`sync-point-${key}`).textContent = `同步點: ${syncPoints[key].toFixed(2)}s`;
            }
        }

        function resetSyncPoints() {
            syncPoints = { a: 0, b: 0, c: 0 };
            syncPointA.textContent = `同步點: 0.00s`;
            syncPointB.textContent = `同步點: 0.00s`;
            syncPointC.textContent = `同步點: 0.00s`;
        }

        function loadVideo(event, videoElement, videoKey, filenameElement, canvasElement) {
            const file = event.target.files[0];
            if (file) {
                const fileURL = URL.createObjectURL(file);
                videoElement.src = fileURL;
                videoElement.muted = true;
                videosLoaded[videoKey] = true;
                filenameElement.textContent = file.name;
                videoElement.onloadeddata = () => {
                    const analysisWidth = 320;
                    const aspectRatio = videoElement.videoWidth / videoElement.videoHeight;
                    const analysisHeight = Math.round(analysisWidth / aspectRatio);
                    canvasElement.width = analysisWidth;
                    canvasElement.height = analysisHeight;
                    seekVideos(0, true);
                };
                checkAllVideosLoaded();
            }
        }
        
        function checkAllVideosLoaded() {
            const anyLoaded = videosLoaded.a || videosLoaded.b || videosLoaded.c;
            if (anyLoaded) {
                controlsPanel.classList.remove('hidden');
                analysisPanel.classList.remove('hidden');
            }
            const mainVideo = getMainVideo();
            if (mainVideo && !isNaN(mainVideo.duration)) {
                updateDuration();
            }
        }

        function togglePlayPause() {
            if (!getMainVideo()) return;
            isPlaying = !isPlaying;
            if (isPlaying) {
                if (videosLoaded.a) videoA.play();
                if (videosLoaded.b) videoB.play();
                if (videosLoaded.c) videoC.play();
                playIcon.classList.replace('fa-play', 'fa-pause');
            } else {
                if (videosLoaded.a) videoA.pause();
                if (videosLoaded.b) videoB.pause();
                if (videosLoaded.c) videoC.pause();
                playIcon.classList.replace('fa-pause', 'fa-play');
            }
        }
        
        function seekVideos(value, calculateSharpness = false) {
            if (!getMainVideo()) return;
            const time = parseFloat(value);
            if(isNaN(time)) return;

            const promises = [];
            if (videosLoaded.a && videoA.seekable) videoA.currentTime = time;
            if (videosLoaded.b && videoB.seekable) videoB.currentTime = time;
            if (videosLoaded.c && videoC.seekable) videoC.currentTime = time;

            if(calculateSharpness) {
                 if (videosLoaded.a) promises.push(new Promise(res => videoA.onseeked = res));
                 if (videosLoaded.b) promises.push(new Promise(res => videoB.onseeked = res));
                 if (videosLoaded.c) promises.push(new Promise(res => videoC.onseeked = res));
            }
            
            updateUI();
            if(calculateSharpness) {
                Promise.all(promises).then(() => {
                    updateAllSharpnessDisplays();
                });
            }
        }

        // Global frame step
        function stepFrame(direction) {
            if (isPlaying) togglePlayPause();
            const mainVideo = getMainVideo();
            if(!mainVideo) return;
            let newTime = mainVideo.currentTime + direction * FRAME_STEP;
            newTime = Math.max(0, Math.min(mainVideo.duration, newTime));
            seekVideos(newTime, true);
        }

        // Individual frame step
        function stepIndividualFrame(key, direction) {
            if (isPlaying) {
                togglePlayPause();
            }
            
            const video = document.getElementById(`video-${key}`);
            if (!video || !videosLoaded[key]) return;
            
            let newTime = video.currentTime + direction * FRAME_STEP;
            newTime = Math.max(0, Math.min(video.duration, newTime));
            
            video.currentTime = newTime;
            video.onseeked = () => {
                const canvas = document.getElementById(`canvas-${key}`);
                const display = document.getElementById(`sharpness-${key}`);
                display.textContent = calculateFrameSharpness(video, canvas).toFixed(2);
                // Update global seek bar to reflect the change
                updateUI();
            };
        }

        function updateUI() {
            const mainVideo = getMainVideo();
            if (mainVideo && !isNaN(mainVideo.duration)) {
                seekBar.value = mainVideo.currentTime;
                currentTimeEl.textContent = formatTime(mainVideo.currentTime);
            }
        }
        
        function updateDuration() {
            const mainVideo = getMainVideo();
            if (mainVideo && !isNaN(mainVideo.duration)) {
                seekBar.max = mainVideo.duration;
                durationEl.textContent = formatTime(mainVideo.duration);
            }
        }

        function formatTime(timeInSeconds) {
            if (isNaN(timeInSeconds)) return "00:00";
            const minutes = Math.floor(timeInSeconds / 60).toString().padStart(2, '0');
            const seconds = Math.floor(timeInSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        // --- Sharpness Analysis Functions ---
        
        function calculateFrameSharpness(video, canvas) {
            if (!video.src || video.readyState < 2) return 0;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            if (canvas.width === 0 || canvas.height === 0) return 0;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const width = canvas.width;
            const grayData = new Uint8Array(width * canvas.height);
            for(let i=0; i < data.length; i+=4) {
                grayData[i/4] = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
            }
            let sumSq = 0;
            let count = 0;
            for (let y = 1; y < canvas.height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const i = y * width + x;
                    const laplaceValue = grayData[i] * 4 - grayData[i-1] - grayData[i+1] - grayData[i-width] - grayData[i+width];
                    sumSq += laplaceValue * laplaceValue;
                    count++;
                }
            }
            if (count === 0) return 0;
            return sumSq / count;
        }
        
        function updateAllSharpnessDisplays() {
            if (videosLoaded.a && !isNaN(videoA.duration)) sharpnessADisplay.textContent = calculateFrameSharpness(videoA, canvasA).toFixed(2);
            if (videosLoaded.b && !isNaN(videoB.duration)) sharpnessBDisplay.textContent = calculateFrameSharpness(videoB, canvasB).toFixed(2);
            if (videosLoaded.c && !isNaN(videoC.duration)) sharpnessCDisplay.textContent = calculateFrameSharpness(videoC, canvasC).toFixed(2);
        }

        function stopAnalysis() {
            analysisCancelled = true;
        }
        
        async function startFullAnalysis() {
            if(isAnalyzing) return;
            const mainVideo = getMainVideo();
            if (!mainVideo) { alert("請先上傳至少一支影片。"); return; }
            
            let relativeStartTime = parseFloat(startTimeInput.value);
            let relativeEndTime = parseFloat(endTimeInput.value);

            relativeStartTime = isNaN(relativeStartTime) ? 0 : Math.max(0, relativeStartTime);
            
            if (isNaN(relativeEndTime)) {
                let minDuration = Infinity;
                if(videosLoaded.a) minDuration = Math.min(minDuration, videoA.duration - syncPoints.a);
                if(videosLoaded.b) minDuration = Math.min(minDuration, videoB.duration - syncPoints.b);
                if(videosLoaded.c) minDuration = Math.min(minDuration, videoC.duration - syncPoints.c);
                relativeEndTime = minDuration;
            }

            if (relativeStartTime >= relativeEndTime) {
                alert("錯誤：開始時間必須小於結束時間。");
                return;
            }
            
            isAnalyzing = true;
            analysisCancelled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-stop"></i> 停止分析';
            analyzeBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            analyzeBtn.classList.add('bg-red-500', 'hover:bg-red-600');

            resultsChartsContainer.classList.add('hidden');
            progressContainer.classList.remove('hidden');
            progressBar.style.width = `0%`;
            lastAnalysisData = null; // Clear previous results

            const analyzeVideo = async (video, canvas, syncPoint, scores, timestamps, progressCallback) => {
                if (!video.src || isNaN(video.duration)) return;
                const frameRate = 30; 
                const frameDuration = 1 / frameRate;
                const rangeDuration = relativeEndTime - relativeStartTime;
                const totalFramesInRange = Math.floor(rangeDuration * frameRate);
                
                for (let i = 0; i < totalFramesInRange; i++) {
                    if (analysisCancelled) break;
                    const currentRelativeTime = i * frameDuration;
                    const absoluteTime = syncPoint + relativeStartTime + currentRelativeTime;

                    if (absoluteTime > video.duration) break; 

                    await new Promise(res => { video.onseeked = res; video.currentTime = absoluteTime; });
                    scores.push(calculateFrameSharpness(video, canvas));
                    timestamps.push(relativeStartTime + currentRelativeTime);
                    progressCallback();
                    await new Promise(res => setTimeout(res, 0)); 
                }
            };
            
            const scoresA = [], timestampsA = [];
            const scoresB = [], timestampsB = [];
            const scoresC = [], timestampsC = [];
            let analyzedFrames = 0;
            
            const getFrames = (video, sync) => videosLoaded[getVideoKey(video)] ? Math.floor(Math.max(0, Math.min(video.duration - sync, relativeEndTime) - relativeStartTime) * 30) : 0;
            const totalFramesToAnalyze = getFrames(videoA, syncPoints.a) + getFrames(videoB, syncPoints.b) + getFrames(videoC, syncPoints.c);


            const progressCallback = () => {
                analyzedFrames++;
                const progress = totalFramesToAnalyze > 0 ? (analyzedFrames / totalFramesToAnalyze) * 100 : 0;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `分析中... (${analyzedFrames} / ${totalFramesToAnalyze} 幀)`;
            };

            const analysisPromises = [];
            if (videosLoaded.a) analysisPromises.push(analyzeVideo(videoA, canvasA, syncPoints.a, scoresA, timestampsA, progressCallback));
            if (videosLoaded.b) analysisPromises.push(analyzeVideo(videoB, canvasB, syncPoints.b, scoresB, timestampsB, progressCallback));
            if (videosLoaded.c) analysisPromises.push(analyzeVideo(videoC, canvasC, syncPoints.c, scoresC, timestampsC, progressCallback));

            await Promise.all(analysisPromises);
            
            lastAnalysisData = {
                tsA: timestampsA, sA: scoresA,
                tsB: timestampsB, sB: scoresB,
                tsC: timestampsC, sC: scoresC,
            };
            displayResults();
            
            isAnalyzing = false;
            analyzeBtn.innerHTML = '<i class="fas fa-chart-line"></i> 重新開始分析';
            analyzeBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            analyzeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            progressContainer.classList.add('hidden');
        }
        
        function redrawChart() {
            if (combinedChartInstance) combinedChartInstance.destroy();
            combinedChartInstance = drawCombinedChart();
        }

        function displayResults() {
            if (!lastAnalysisData) return;
            resultsChartsContainer.classList.remove('hidden');
            
            const { sA, sB, sC } = lastAnalysisData;
            const clearThreshold = parseFloat(clearThresholdInput.value);
            const blurryThreshold = parseFloat(blurryThresholdInput.value);
            
            // Display stats
            [resultAEl, resultBEl, resultCEl, chartLegendControls].forEach(el => el.classList.add('hidden'));
            [showLineA, showLineB, showLineC].forEach(el => el.parentElement.classList.add('hidden'));

            if (sA.length > 0) {
                displayStatisticsForVideo(sA, 'a', clearThreshold, blurryThreshold);
                resultAEl.classList.remove('hidden');
                showLineA.parentElement.classList.remove('hidden');
            }
            if (sB.length > 0) {
                displayStatisticsForVideo(sB, 'b', clearThreshold, blurryThreshold);
                resultBEl.classList.remove('hidden');
                showLineB.parentElement.classList.remove('hidden');
            }
            if (sC.length > 0) {
                displayStatisticsForVideo(sC, 'c', clearThreshold, blurryThreshold);
                resultCEl.classList.remove('hidden');
                showLineC.parentElement.classList.remove('hidden');
            }

            // Display combined chart
            const anyData = sA.length > 0 || sB.length > 0 || sC.length > 0;
            if (anyData) {
                 chartLegendControls.classList.remove('hidden');
                 redrawChart();
                 combinedChartContainer.classList.remove('hidden');
            } else {
                combinedChartContainer.classList.add('hidden');
            }
        }
        
        function displayStatisticsForVideo(scores, key, clearT, blurryT) {
            if (scores.length === 0) return;
            const total = scores.length;
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = sum / total;
            const clearCount = scores.filter(s => s >= clearT).length;
            const slightCount = scores.filter(s => s >= blurryT && s < clearT).length;
            const blurCount = scores.filter(s => s < blurryT).length;

            document.getElementById(`avg-sharpness-${key}`).textContent = avg.toFixed(2);
            document.getElementById(`clear-ratio-${key}`).textContent = `${(clearCount / total * 100).toFixed(1)}%`;
            document.getElementById(`slight-ratio-${key}`).textContent = `${(slightCount / total * 100).toFixed(1)}%`;
            document.getElementById(`blur-ratio-${key}`).textContent = `${(blurCount / total * 100).toFixed(1)}%`;
        }

        function drawCombinedChart() {
            if(!lastAnalysisData) return null;

            const { tsA, sA, tsB, sB, tsC, sC } = lastAnalysisData;
            const clearT = parseFloat(clearThresholdInput.value);
            const blurryT = parseFloat(blurryThresholdInput.value);

            const ctx = document.getElementById('combined-chart').getContext('2d');
            const datasets = [];
            
            if(showLineA.checked && sA.length > 0) {
                 datasets.push({
                    label: '影片 A',
                    data: sA,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            if(showLineB.checked && sB.length > 0) {
                 datasets.push({
                    label: '影片 B',
                    data: sB,
                    borderColor: 'rgb(249, 115, 22)',
                    backgroundColor: 'rgba(249, 115, 22, 0.5)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            if(showLineC.checked && sC.length > 0) {
                 datasets.push({
                    label: '影片 C',
                    data: sC,
                    borderColor: 'rgb(22, 163, 74)',
                    backgroundColor: 'rgba(22, 163, 74, 0.5)',
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1
                });
            }
            
            const allTimestamps = [tsA, tsB, tsC].sort((a,b) => b.length - a.length)[0] || [];
            const allScores = datasets.flatMap(ds => ds.data);
            const yMax = allScores.length > 0 ? Math.max(...allScores, clearT, blurryT) * 1.1 : Math.max(clearT, blurryT) * 1.1;

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: allTimestamps.map(l => l.toFixed(2)),
                    datasets: datasets
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: yMax
                        },
                        x: {
                            type: 'linear',
                            ticks: {
                                maxTicksLimit: 10,
                                callback: function(value, index, values) {
                                    return value.toFixed(2) + 's';
                                }
                            },
                             title: {
                                display: true,
                                text: '相對於同步點的時間 (秒)'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }, // Use custom legend
                        annotation: {
                           annotations: {
                                clearZone: {
                                    type: 'box',
                                    yMin: clearT,
                                    yMax: yMax,
                                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                    borderColor: 'rgba(34, 197, 94, 0.3)',
                                    borderWidth: 1,
                                },
                                slightZone: {
                                    type: 'box',
                                    yMin: blurryT,
                                    yMax: clearT,
                                    backgroundColor: 'rgba(234, 179, 8, 0.1)',
                                    borderColor: 'rgba(234, 179, 8, 0.3)',
                                    borderWidth: 1,
                                },
                                blurZone: {
                                    type: 'box',
                                    yMin: 0,
                                    yMax: blurryT,
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    borderColor: 'rgba(239, 68, 68, 0.3)',
                                    borderWidth: 1,
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return `時間: ${context[0].label}s`;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
